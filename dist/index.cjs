"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});let l;const p=async(e,n,t)=>{var f;if((e.headers.upgrade||((f=e==null?void 0:e.headers)==null?void 0:f.get("Upgrade")))!=="websocket"&&!n)return;let a;return d&&await d(e,()=>{if(n){const i=new l({noServer:!0});let r;const s=[];return new Proxy({},{get(g,u,S){return u==="accept"?()=>{i.once("connection",c=>{r=c,s.length&&(s.forEach(([h,...w])=>{r[h](...w)}),s.length=0)}),i.handleUpgrade(e,n,t,c=>{i.emit("connection",c,e)})}:r?Reflect.get(r,u,r):(...c)=>{s.push([u,...c])}}})}else{const i=globalThis,r=new i.WebSocketPair,s=r[0],g=r[1];return a=new Response(null,{status:101,webSocket:s}),g}}),a};function v(){return{name:"svelte-kit-websocket",async transform(e,n){if(n.endsWith("@sveltejs/kit/src/runtime/server/index.js")){const t="async respond(request, options) {";return e='import {dev} from "$app/environment";import {handle} from "vite-sveltekit-cf-ws";'+e.replace(t,`${t}if(!dev){const res = await handle(request);if(res)return res}`),{code:e}}return null},async configureServer(e){var n;if(!l){const t=()=>{if(!e.ws){setTimeout(t);return}const o=function(a){l=this.constructor,e.ws.off("connection",o)};e.ws.on("connection",o)};t()}(n=e.httpServer)==null||n.on("upgrade",async(t,o,a)=>{await p(t,o,a)})}}}let d;const m=e=>{d=e};exports.default=v;exports.handle=p;exports.handleUpgrade=m;
