"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});let c;const p=async(e,n,r)=>{var g;if((e.headers.upgrade||((g=e==null?void 0:e.headers)==null?void 0:g.get("Upgrade")))!=="websocket"||c&&!n)return;let i;return d&&await d(e,()=>{if(c){const a=new c({noServer:!0});let t;const s=[];return new Proxy({},{get(h,u,k){return u==="accept"?()=>{a.once("connection",o=>{t=o,s.length&&(s.forEach(([w,...v])=>{t[w](...v)}),s.length=0)}),a.handleUpgrade(e,n,r,o=>{a.emit("connection",o,e)})}:t?Reflect.get(t,u,t):(...o)=>{s.push([u,...o])}}})}else{const a=globalThis,t=new a.WebSocketPair,s=t[0],h=t[1];return i=new Response(null,{status:101,webSocket:s}),h}}),i};function S(){return{name:"svelte-kit-websocket",async transform(e,n){if(n.endsWith("@sveltejs/kit/src/runtime/server/index.js")){const r="async respond(request, options) {";return e='import {handle} from "vite-sveltekit-cf-ws";'+e.replace(r,`${r}const res = await handle(request);if(res)return res;`),{code:e}}return null},async configureServer(e){var r;const n=function(l){e.ws.off("connection",n),c=this.constructor};e.ws.on("connection",n),(r=e.httpServer)==null||r.on("upgrade",async(l,i,f)=>{c&&await p(l,i,f)})}}}let d;const b=e=>{d=e};exports.default=S;exports.handle=p;exports.handleUpgrade=b;
