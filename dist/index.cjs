"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});let a;const p=async(e,r,n)=>{var g;if((e.headers.upgrade||((g=e==null?void 0:e.headers)==null?void 0:g.get("Upgrade")))!=="websocket"||a&&!r)return;let o;return d&&await d(e,()=>{if(a){const i=new a({noServer:!0});let t;const s=[];return new Proxy({},{get(h,l,k){return l==="accept"?()=>{i.handleUpgrade(e,r,n,u=>{t=u,s.length&&(s.forEach(([w,...v])=>{t[w](...v)}),s.length=0)})}:t?Reflect.get(t,l,t):(...u)=>{s.push([l,...u])}}})}else{const i=globalThis,t=new i.WebSocketPair,s=t[0],h=t[1];return o=new Response(null,{status:101,webSocket:s}),h}}),o};function S(){return{name:"svelte-kit-websocket",async transform(e,r){if(r.endsWith("@sveltejs/kit/src/runtime/server/index.js")){const n="async respond(request, options) {";return e='import {handle} from "vite-sveltekit-cf-ws";'+e.replace(n,`${n}const res = await handle(request);if(res)return res;`),{code:e}}return null},async configureServer(e){var n;const r=function(c){e.ws.off("connection",r),a=this.constructor};e.ws.on("connection",r),(n=e.httpServer)==null||n.on("upgrade",async(c,o,f)=>{a&&await p(c,o,f)})}}}let d;const b=e=>{d=e};exports.default=S;exports.handle=p;exports.handleUpgrade=b;
